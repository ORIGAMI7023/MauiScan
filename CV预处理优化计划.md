# CV预处理优化计划

## 📋 背景问题

### 当前状况
- **成功率**：baseline方法仅61.1%
- **核心问题**：算法检测到**幕布边缘**而非**PPT边缘**
- **原因分析**：
  - 幕布边缘对比度强，容易检测
  - PPT边缘对比度弱，经常检测不到（在Canny边缘图中就没有）
  - 幕布内边缘虽然可以检测到，但被干扰线条影响

### 已测试的6个方法（240张图片）
| 方法 | 成功率 | 平均分 | 评价 |
|------|--------|--------|------|
| baseline | 61.1% | 52.4 | 最好 |
| adaptive_canny | 57.3% | 49.7 | 次好 |
| stronger_blur | 56.9% | 49.1 | 一般 |
| no_blur | 56.1% | 49.6 | 一般 |
| morphology | 53.1% | 56.3 | 一般 |
| **clahe** | **36.4%** | 31.2 | **最差**（过度增强内部细节） |

---

## 🎯 当前计划：完成30方法参数测试脚本

### 测试矩阵设计

#### 现有6个方法 × 3参数水平 = 18个

| 方法 | 参数 | 低 | 中(当前) | 高 |
|------|------|-----|----------|-----|
| **baseline** | Canny阈值 | 20/80 | 30/100 | 40/120 |
| **no_blur** | Canny阈值 | 20/80 | 30/100 | 40/120 |
| **stronger_blur** | kernel | 5x5 | 7x7 | 9x9 |
| **clahe** | clipLimit | 1.0 | 2.0 | 3.0 |
| **morphology** | kernel闭运算 | 3x3 | 5x5 | 7x7 |
| **adaptive_canny** | 中值系数 | 0.5/1.5 | 0.66/1.33 | 0.8/1.2 |

#### 新增4个方法 × 3参数水平 = 12个

| 方法 | 描述 | 参数 | 低 | 中 | 高 |
|------|------|------|-----|-----|-----|
| **sharpening** | 边缘锐化 | 锐化强度 | 0.5 | 1.0 | 2.0 |
| **bilateral** | 双边滤波（保边去噪） | (d, sigmaC, sigmaS) | (5,30,30) | (9,50,50) | (13,75,75) |
| **morph_gradient** | 形态学梯度 | kernel梯度 | 3x3 | 5x5 | 7x7 |
| **multi_scale_canny** | 多尺度Canny融合 | 尺度数量 | 2尺度 | 3尺度 | 4尺度 |

#### 测试规模
- **总方法数**：30个
- **总测试数**：240张图 × 30方法 = 7200个
- **预计耗时**：5-10分钟（32线程并行）

### 输出内容
1. 每个方法的可视化结果（4宫格图）
2. 每张图的JSON结果
3. 汇总CSV报告（30个方法对比）

---

## 📅 下一步：运行测试并分析结果

### 步骤1：执行测试脚本
```bash
python D:\Programing\C#\MauiScan\test_preprocessing_methods.py
```

### 步骤2：分析结果
```bash
python D:\Programing\C#\MauiScan\analyze_preprocessing_results.py
```

### 步骤3：评估指标
- 成功率（最重要）
- 平均分数
- 平均IoU
- 包含中心点比例

---

## 📅 下一步：剔除极差方法，组合测试

### 筛选标准
- **剔除**：成功率 < 50% 的方法
- **保留**：成功率 ≥ 50% 的方法

### 组合测试
对保留的方法进行**排列组合**测试：
- 例如：`sharpening_mid` + `baseline_low`
- 例如：`bilateral_high` + `morphology_mid`

### 组合策略
1. 预处理方法（锐化/双边滤波/形态学梯度）
2. + 边缘检测方法（baseline/adaptive_canny）
3. = 组合方法

预计测试：10-20个有潜力的组合

---

## 📅 最后：决定最终方案

### 如果组合方法效果好（成功率 > 75%）
- ✅ 直接采用最佳组合
- 部署到C++代码

### 如果效果仍不理想（成功率 < 75%）
- ❌ 单纯预处理优化不够
- 🔄 启用**方案3**：多轮廓检测+可视化调试

---

## 🔧 方案3：多轮廓检测（备选）

### 核心思路
不再只选"最高分的轮廓"，而是：
1. 检测**所有候选轮廓**
2. 可视化标注序号（按面积/分数排序）
3. 分析PPT通常排在第几位
4. 根据规律选择（例如：选择第2大的轮廓）

### 实施步骤
1. 写可视化脚本：显示前5个候选轮廓
2. 人工分析：PPT的位置规律
3. 制定选择策略：
   - 如果检测到嵌套轮廓，选内层
   - 如果检测到多个并列轮廓，选第2大且包含中心的
   - 如果只有1个轮廓，保持原逻辑

---

## 📂 相关文件

### 脚本文件
- `test_preprocessing_methods.py` - 主测试脚本（30方法）
- `analyze_preprocessing_results.py` - 结果分析脚本
- `test_center_filter.py` - 中心点过滤测试（暂未使用）

### 数据文件
- 输入：`AnnotationTool/data/` - 240张标注图片
- 输出：`preprocessing_results/` - 测试结果
  - `{image_name}/{method_name}.jpg` - 可视化结果
  - `{image_name}/results.json` - JSON数据
  - `summary.csv` - 汇总报告
  - `detailed_analysis.csv` - 详细分析

### 文档文件
- `CV精修优化方案.md` - 之前的ML角点精修分析（已完成，不相关）
- `CV预处理优化计划.md` - 本文档

---

## 📊 决策树

```
开始：30方法测试
  │
  ├─ 有方法达到75%+ ？
  │   ├─ YES → 采用最佳方法 → 完成
  │   └─ NO → 继续
  │
  ├─ 有方法达到60%+ ？
  │   ├─ YES → 尝试组合测试
  │   │          │
  │   │          ├─ 组合后 > 75% ？
  │   │          │   ├─ YES → 采用组合 → 完成
  │   │          │   └─ NO → 启用方案3
  │   │
  │   └─ NO → 全部失败，直接启用方案3
  │
  └─ 方案3：多轮廓检测
      ├─ 可视化调试
      ├─ 分析规律
      ├─ 制定策略
      └─ 实施测试
```

---

## ⏰ 时间估计

- ✅ **当前任务**：完成30方法脚本（30分钟）
- ⏳ **测试运行**：执行测试（10分钟）
- ⏳ **结果分析**：查看报告（15分钟）
- ⏳ **组合测试**：如需要（1小时）
- ⏳ **方案3实施**：如需要（2-3小时）

---

## 📌 当前状态

- [x] 完成6个方法的baseline测试
- [x] 分析结果，发现问题
- [x] 实现30方法测试脚本
- [x] 运行测试
- [x] 分析结果
- [x] 实现加密采样+组合测试（91种组合）
- [x] **测试完成：找到最佳方案！**

## 🎉 最终结果

### 最佳组合方案
**baseline + MultiScaleCanny(5尺度)**
- **成功率：79.5%**（提升20.9%）
- 预处理：Gaussian5x5 + Contrast1.15
- 边缘检测：5尺度Canny融合（kernel 3,5,7,9,11）

### 下一步：部署到C++
1. 修改 `Native.OpenCV/src/opencv_scanner.cpp`
2. 实现多尺度Canny边缘检测
3. 测试并验证效果
4. 如仍不满意，启用方案3（多轮廓检测）

---

*最后更新：2025-12-08*
