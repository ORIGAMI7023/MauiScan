# PPT 四角点标注工具

用于标注教室投屏 PPT 图片的四个角点，生成机器学习训练数据。

## 功能特性

- ✅ 批量加载图片文件夹
- ✅ 鼠标点击标注四个角点（左上→右上→右下→左下）
- ✅ 拖拽调整角点位置
- ✅ 鼠标滚轮缩放图片（以鼠标为中心）
- ✅ 支持标注画面外的角点（处理边缘超出情况）
- ✅ 自动保存为 JSON 格式
- ✅ 断点续标（自动加载已标注数据）
- ✅ 窗体自适应缩放

## 使用方法

### 启动程序

```cmd
cd D:\Programing\C#\MauiScan\AnnotationTool
dotnet run
```

### 操作步骤

1. **加载图片**：点击"加载图片文件夹"按钮，选择包含 PPT 照片的文件夹
2. **标注角点**：按顺序点击四个角点（左上→右上→右下→左下）
3. **调整位置**：拖拽红色圆圈微调角点位置
4. **缩放查看**：滚动鼠标滚轮放大/缩小图片
5. **保存标注**：按 `Enter` 保存并跳转下一张

### 快捷键

| 按键 | 功能 |
|------|------|
| `Enter` | 保存当前标注并跳转下一张 |
| `Space` | 跳过当前图片 |
| `←` / `→` | 上一张 / 下一张 |
| `Backspace` | 清除当前所有角点 |
| `Esc` | 清除当前所有角点 |
| `R` | 重置缩放 |
| 滚轮 | 放大/缩小图片 |

## 输出格式

标注数据保存在与图片同目录的 JSON 文件中。

### 文件命名

```
image001.jpg  → image001.json
photo.png     → photo.json
```

### JSON 格式

```json
{
  "Corners": [
    { "X": 120, "Y": 80 },
    { "X": 920, "Y": 100 },
    { "X": 900, "Y": 680 },
    { "X": 100, "Y": 700 }
  ]
}
```

## 坐标系统说明

### 坐标原点

- **原点位置**：图片左上角为 `(0, 0)`
- **X 轴**：向右为正
- **Y 轴**：向下为正

### 坐标单位

- **单位**：像素（px）
- **参考系**：原始图片分辨率（不受缩放影响）

### 坐标范围

**标准情况**（四个角点都在图片内）：
```
0 ≤ X ≤ imageWidth
0 ≤ Y ≤ imageHeight
```

**边缘超出情况**（1-2% 的数据）：

角点可能超出图片边界，此时坐标**允许为负数或超过图片尺寸**。

#### 示例 1：左上角超出

```json
{
  "Corners": [
    { "X": -50, "Y": -30 },    // 左上角超出画面
    { "X": 920, "Y": 100 },    // 右上角正常
    { "X": 900, "Y": 680 },    // 右下角正常
    { "X": 100, "Y": 700 }     // 左下角正常
  ]
}
```

**解释**：
- `X = -50` 表示该角点在图片左边缘外 50 像素处
- `Y = -30` 表示该角点在图片上边缘外 30 像素处

#### 示例 2：右下角超出

假设图片尺寸为 `1920×1080`：

```json
{
  "Corners": [
    { "X": 120, "Y": 80 },
    { "X": 920, "Y": 100 },
    { "X": 1950, "Y": 1100 },  // 右下角超出画面
    { "X": 100, "Y": 700 }
  ]
}
```

**解释**：
- `X = 1950` 超出图片宽度（1920），表示在右边缘外 30 像素
- `Y = 1100` 超出图片高度（1080），表示在下边缘外 20 像素

### 坐标精度

- **数据类型**：整数（`int`）
- **精度要求**：10-20 像素误差可接受
- **不需要亚像素精度**

## 机器学习使用说明

### 坐标系统设计

本工具的坐标系统设计如下：

1. **绝对坐标系**：基于原始图片分辨率
2. **允许越界**：坐标可以为负数或超过图片尺寸
3. **真实反映**：标注的是 PPT 角点的实际几何位置，而非限制在画面内

### 数据处理建议

#### 方案 1：直接使用（推荐）

```python
# 直接使用坐标训练模型
corners = [(x1, y1), (x2, y2), (x3, y3), (x4, y4)]

# 模型会学习：
# - 正常情况：四个角点都在 [0, width] × [0, height] 范围内
# - 边缘情况：部分角点超出边界
```

#### 方案 2：归一化坐标

```python
# 转换为相对坐标 [0, 1]
normalized_x = x / image_width
normalized_y = y / image_height

# 超出边界时：
# normalized_x < 0 或 > 1
# normalized_y < 0 或 > 1
```

#### 方案 3：边界限制（不推荐）

```python
# 将超出坐标夹紧到边界
clipped_x = max(0, min(x, image_width))
clipped_y = max(0, min(y, image_height))
```

⚠️ **不推荐原因**：会丢失"角点实际在画面外"的重要信息。

### 数据统计

**预期分布**：
- 98-99% 数据：四个角点都在图片内
- 1-2% 数据：1 个角点超出画面
- 0% 数据：2 个或以上角点超出

**超出范围**：
- 通常超出 10-100 像素
- 极少超出 200 像素以上

### 透视变换应用

```python
import cv2
import numpy as np

# 读取标注
corners = np.array([
    [x1, y1],  # 左上
    [x2, y2],  # 右上
    [x3, y3],  # 右下
    [x4, y4]   # 左下
], dtype=np.float32)

# 定义目标矩形（A4 比例 1:1.414）
dst = np.array([
    [0, 0],
    [800, 0],
    [800, 1131],
    [0, 1131]
], dtype=np.float32)

# 计算透视变换矩阵
# 即使部分角点超出边界，透视变换仍然有效
matrix = cv2.getPerspectiveTransform(corners, dst)
result = cv2.warpPerspective(image, matrix, (800, 1131))
```

**关键点**：OpenCV 的透视变换可以处理超出图片边界的坐标，会自动进行几何外推。

## 数据采集建议

### 推荐数据量

- **第一个教室**：300-400 张（完整采集）
- **新教室补充**：20-100 张（按需补充）

### 场景覆盖

**常规场景（80%）**：
- 3 个角度（正面、左侧、右侧）
- 3 台设备（不同手机/相机）
- 每个 PPT 拍摄 9-27 张

**困难场景（20%）**：
- 高亮度环境（窗户强光、投影过曝）
- 低亮度环境（关灯、暗场）
- 边缘超出（1-2% 比例）

### PPT 选择

- 不需要专门设计 PPT 内容
- 随机 PPT 即可，内容不重要
- 建议包含：
  - 深色背景（黑底白字）
  - 浅色背景（白底黑字）
  - 图表、图片混合内容

### 拍摄距离

- **主要**（70%）：PPT 占画面 20-40%
- **近景**（20%）：PPT 占画面 40-60%
- **远景**（10%）：PPT 占画面 10-20%

## 标注质量控制

### 角点顺序

**严格按照顺序标注**：
1. 左上角
2. 右上角
3. 右下角
4. 左下角

⚠️ 顺序错误会导致透视变换结果翻转或扭曲！

### 精度要求

- ✅ **可接受**：10-20 像素误差
- ⚠️ **需要重标**：> 50 像素误差
- ❌ **无效标注**：顺序错误、点在 PPT 内部

### 边缘超出处理

**如何标注超出的角点**：

1. 使用滚轮**放大图片**
2. 观察可见的三条边
3. **延长边缘线**，推断第四个角的位置
4. **拖拽角点**到画面外对应位置
5. 根据边框对齐检查是否准确

**示例**：
```
可见：右上、右下、左下三个角
不可见：左上角超出画面
操作：
  1. 连接右上-右下的右边缘
  2. 连接左上-左下的左边缘（部分可见）
  3. 延长左边缘和上边缘，交点即为左上角
  4. 将标注点拖到画面左上角外侧
```

## 支持的图片格式

- ✅ **JPG/JPEG** - 推荐，文件小
- ✅ **PNG** - 支持，文件较大
- ✅ **BMP** - 支持，文件很大

**推荐格式**：
- **采集阶段**：手机相机默认格式（通常是 JPG）
- **存储阶段**：保持原格式，无需转换
- **训练阶段**：任何格式都可以，机器学习框架会自动处理

**不推荐**：
- ❌ **HEIC**（iPhone 默认格式）- 需要先转换为 JPG
- ❌ **WEBP** - 当前工具不支持
- ❌ **RAW** - 文件过大，无必要

## 故障排除

### 程序无法启动

```cmd
# 检查 .NET SDK 版本
dotnet --version

# 应该是 10.0 或更高版本
# 如果版本过低，请更新 .NET SDK
```

### 图片无法加载

- 检查图片格式是否支持（JPG/PNG/BMP）
- 检查文件是否损坏
- 检查文件路径是否包含中文（支持中文路径）

### 标注无法保存

- 检查是否已标注完整 4 个角点
- 检查文件夹是否有写入权限
- 检查磁盘空间是否充足

### 缩放不正常

- 按 `R` 键重置缩放
- 重新加载当前图片（按 `Space` 再按 `←`）

## 开发信息

- **开发语言**：C# 10
- **框架**：.NET 10 WinForms
- **开发时间**：2025-12-07
- **项目路径**：`D:\Programing\C#\MauiScan\AnnotationTool\`

## 许可协议

本工具是 MauiScan 项目的一部分，用于内部数据标注。
