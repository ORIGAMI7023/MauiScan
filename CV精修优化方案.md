# CVç²¾ä¿®ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“Š å½“å‰é—®é¢˜åˆ†æï¼ˆåŸºäº13å¼ æµ‹è¯•å›¾ç‰‡ï¼‰

### æˆåŠŸç‡ç»Ÿè®¡
- **TEST.jpg**: 4/4 æˆåŠŸ âœ… (å…¨éƒ¨confidence=2)
- **å¤§éƒ¨åˆ†å›¾ç‰‡**: éƒ¨åˆ†æˆåŠŸæˆ–å®Œå…¨å¤±è´¥
- **ä¸»è¦å¤±è´¥åŸå› **: å‚ç›´çº¿æ£€æµ‹ä¸åˆ°æˆ–å¤ªå°‘

### å¤±è´¥æ¨¡å¼

#### 1ï¸âƒ£ å‚ç›´çº¿æ£€æµ‹å¤±è´¥ (æœ€å¸¸è§)
```
ç¤ºä¾‹: P20251207-080152.jpg
  TL: åªæœ‰1æ¡çº¿ â†’ å¤±è´¥
  TR: H=13, V=0 â†’ ç¼ºå°‘Vçº¿
  BR: H=18, V=0 â†’ ç¼ºå°‘Vçº¿
  BL: H=21, V=0 â†’ ç¼ºå°‘Vçº¿
```

**åŸå› :**
- å…‰ç…§é—®é¢˜ï¼ˆè¾¹ç¼˜æ¨¡ç³Šï¼‰
- èƒŒæ™¯å¹²æ‰°ï¼ˆç™½å¢™ä¸Šçš„ç™½çº¸ï¼‰
- ç›´çº¿åˆ†ç±»é€»è¾‘è¿‡äºç®€å•

#### 2ï¸âƒ£ Vçº¿å¤ªå°‘å¯¼è‡´ç½®ä¿¡åº¦ä½
```
ç¤ºä¾‹: P20251207-080138.jpg
  BR: H=35, V=1 â†’ confidence=1 (å‹‰å¼ºæˆåŠŸï¼Œåç§»69px)
  BL: H=30, V=1 â†’ æ‹Ÿåˆå¤±è´¥
```

**åŸå› :** åªæœ‰1æ¡Vçº¿æ—¶ï¼Œæ‹Ÿåˆå®¹æ˜“å¤±è´¥ï¼ˆç‚¹å¤ªå°‘ï¼‰

#### 3ï¸âƒ£ æˆåŠŸæ¡ˆä¾‹çš„ç‰¹å¾
```
TEST.jpg (å…¨éƒ¨æˆåŠŸ):
  TL: H=15, V=2 â†’ confidence=2, åç§»57px âœ…
  TR: H=18, V=5 â†’ confidence=2, åç§»70px âœ…
  BR: H=14, V=3 â†’ confidence=2, åç§»107px âœ…
  BL: H=5,  V=2 â†’ confidence=2, åç§»55px âœ…
```

**å…³é”®:** è‡³å°‘éœ€è¦ **Hâ‰¥2 ä¸” Vâ‰¥2** æ‰èƒ½ç¨³å®šæˆåŠŸ

---

## ğŸ” æ ¹æœ¬åŸå› 

### é—®é¢˜1: ç›´çº¿åˆ†ç±»é€»è¾‘è¿‡äºç®€å•

**å½“å‰å®ç° (C++ å’Œ Python):**
```cpp
// opencv_scanner.cpp:556-563
if (dx > dy) {
    horizontalLines.push_back(line);
} else {
    verticalLines.push_back(line);
}
```

**é—®é¢˜:**
- å¯¹äºé€è§†æ‹æ‘„çš„PPTï¼Œ"å‚ç›´è¾¹"å¯èƒ½å€¾æ–œ30-45Â°
- ç”¨ `dx > dy` åˆ¤æ–­æ–¹å‘ï¼Œ45Â°çš„çº¿ä¼šè¢«è¯¯åˆ†ç±»
- å¯¼è‡´æœ¬è¯¥æ˜¯Vçº¿çš„è¢«åˆ†åˆ°Hçº¿ç»„
- **ç»“æœ:** å¾ˆå¤šå›¾ç‰‡æ£€æµ‹åˆ°å¤§é‡Hçº¿ä½†Vçº¿=0

### é—®é¢˜2: Houghå‚æ•°ç›¸å¯¹ä¸¥æ ¼

**å½“å‰å‚æ•°:**
```cpp
int minLineLength = max(10, PATCH_SIZE / 8);  // å¯¹äº255px patch = 31px
HoughLinesP(edges, lines, 1, CV_PI / 180, 15, minLineLength, 10);
//                                          ^^  ^^^^^^^^^^^^
//                                    threshold  min_length
```

**é—®é¢˜:**
- å¯¹äºæ¨¡ç³Šçš„è¾¹ç¼˜ï¼Œå¾ˆéš¾è¾¾åˆ°15ç¥¨
- 31pxçš„æœ€å°é•¿åº¦å¯¹æ–­è£‚çš„è¾¹ç¼˜ä¸å¤Ÿå‹å¥½
- ä½†TEST.jpgæˆåŠŸè¯´æ˜å‚æ•°åŸºæœ¬å¤Ÿç”¨ï¼Œä¸æ˜¯ä¸»è¦é—®é¢˜

---

## ğŸ’¡ ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆA: æ”¹è¿›ç›´çº¿åˆ†ç±»é€»è¾‘ â­ **æ¨èä¼˜å…ˆå°è¯•**

#### Pythonç‰ˆæœ¬ï¼ˆç”¨äºéªŒè¯ï¼‰
```python
# ä¸ç”¨ dx > dyï¼Œè€Œæ˜¯ç”¨è§’åº¦é˜ˆå€¼
for line in lines:
    x1_l, y1_l, x2_l, y2_l = line[0]
    dx = x2_l - x1_l
    dy = y2_l - y1_l

    # è®¡ç®—ç›´çº¿è§’åº¦ï¼ˆç›¸å¯¹äºæ°´å¹³çº¿ï¼‰
    angle = np.arctan2(abs(dy), abs(dx)) * 180 / np.pi

    # åˆ†ç±»ï¼š
    # - æ°´å¹³çº¿: 0-30Â°
    # - å‚ç›´çº¿: 60-90Â°
    # - å…¶ä»–è§’åº¦: å¿½ç•¥ï¼ˆå¯èƒ½æ˜¯å¹²æ‰°çº¿ï¼‰
    if angle < 30:
        horizontal_lines.append(line[0])
    elif angle > 60:
        vertical_lines.append(line[0])
    # 30-60åº¦çš„çº¿è¢«å¿½ç•¥
```

#### C++ç‰ˆæœ¬ï¼ˆå®é™…éƒ¨ç½²ï¼‰
```cpp
// åœ¨ opencv_scanner.cpp:556 æ›¿æ¢
for (const auto& line : lines) {
    float dx = static_cast<float>(line[2] - line[0]);
    float dy = static_cast<float>(line[3] - line[1]);

    // è®¡ç®—è§’åº¦ï¼ˆ0-90åº¦ï¼‰
    float angle = std::atan2(std::abs(dy), std::abs(dx)) * 180.0f / CV_PI;

    if (angle < 30.0f) {
        horizontalLines.push_back(line);  // 0-30åº¦ = æ°´å¹³
    } else if (angle > 60.0f) {
        verticalLines.push_back(line);    // 60-90åº¦ = å‚ç›´
    }
    // 30-60åº¦çš„çº¿è¢«å¿½ç•¥ï¼ˆå¯èƒ½æ˜¯PPTå†…å®¹çš„æ–œçº¿ï¼‰
}
```

**ä¼˜ç‚¹:**
- å¯¹é€è§†å˜å½¢æ›´é²æ£’
- å¯ä»¥è¿‡æ»¤æ‰30-60Â°çš„å¹²æ‰°çº¿
- ä¸å¢åŠ è¯¯æ£€é£é™©

**ç¼ºç‚¹:**
- éœ€è¦ä¿®æ”¹C++ä»£ç å¹¶é‡æ–°ç¼–è¯‘åº“

---

### æ–¹æ¡ˆB: é™ä½Houghé˜ˆå€¼

```cpp
// opencv_scanner.cpp:544
int minLineLength = std::max(10, PATCH_SIZE / 10);  // ä» /8 æ”¹ä¸º /10
HoughLinesP(edges, lines, 1, CV_PI / 180, 10, minLineLength, 15);
//                                          ^^              ^^
//                                    ä»15é™åˆ°10      gapä»10æåˆ°15
```

**ä¼˜ç‚¹:**
- å¯ä»¥æ£€æµ‹åˆ°æ›´å¤šè¾¹ç¼˜
- å¯¹æ¨¡ç³Šå›¾ç‰‡æ›´å‹å¥½

**ç¼ºç‚¹:**
- å¯èƒ½å¢åŠ å™ªå£°çº¿
- éœ€è¦é…åˆæ–¹æ¡ˆAä½¿ç”¨

---

### æ–¹æ¡ˆC: å¢åŠ å®¹é”™é€»è¾‘ï¼ˆå…œåº•ï¼‰

**å½“Vçº¿å¤ªå°‘æ—¶ï¼Œä»æ‰€æœ‰çº¿ä¸­å¼ºåˆ¶é€‰æ‹©æœ€å‚ç›´çš„çº¿:**

```cpp
// åœ¨åˆ†ç±»åæ·»åŠ 
if (verticalLines.size() < 2 && lines.size() >= 2) {
    // æŒ‰å‚ç›´åº¦æ’åºï¼Œé€‰æ‹©æœ€å‚ç›´çš„2æ¡
    std::vector<std::pair<Vec4i, float>> sorted_lines;
    for (const auto& line : lines) {
        float dx = std::abs(static_cast<float>(line[2] - line[0]));
        float dy = std::abs(static_cast<float>(line[3] - line[1]));
        float verticality = dy / (dx + 1e-6);  // å‚ç›´åº¦ï¼šdy/dxï¼Œè¶Šå¤§è¶Šå‚ç›´
        sorted_lines.push_back({line, verticality});
    }

    std::sort(sorted_lines.begin(), sorted_lines.end(),
        [](const auto& a, const auto& b) { return a.second > b.second; });

    // å–å‰2æ¡æœ€å‚ç›´çš„
    verticalLines.clear();
    for (int i = 0; i < std::min(2, (int)sorted_lines.size()); i++) {
        verticalLines.push_back(sorted_lines[i].first);
    }
}
```

**ä¼˜ç‚¹:**
- å…œåº•æ–¹æ¡ˆï¼Œç¡®ä¿è‡³å°‘æœ‰2æ¡Vçº¿
- æé«˜æˆåŠŸç‡

**ç¼ºç‚¹:**
- å¯èƒ½é€‰æ‹©é”™è¯¯çš„çº¿
- åº”è¯¥ä½œä¸ºæœ€åçš„å…œåº•æ‰‹æ®µ

---

### æ–¹æ¡ˆD: è°ƒæ•´C#å±‚çš„éªŒè¯é€»è¾‘

#### D1: ä¿®å¤ç¦»ç¾¤æ£€æµ‹ï¼ˆä¹‹å‰å°è¯•è¿‡ï¼Œæ•ˆæœä¸å¥½ï¼‰
```csharp
// ä» && æ”¹ä¸º ||
bool isOutlier = distances[i] > 2 * avgOthers || distances[i] > 100;
```
**é—®é¢˜:** ä¼šè¯¯æ€æ­£ç¡®çš„ç²¾ä¿®

#### D2: æ·»åŠ è¾¹é•¿å˜åŒ–æ£€æŸ¥ï¼ˆä¹‹å‰å°è¯•è¿‡ï¼Œæ•ˆæœä¸å¥½ï¼‰
```csharp
// æ£€æŸ¥è¾¹é•¿å˜åŒ–æ˜¯å¦>15%
if (changeRatio > 0.15f) { /* å›é€€ */ }
```
**é—®é¢˜:** ä¼šè¯¯æ€æ­£ç¡®çš„ç²¾ä¿®

**ç»“è®º:** C#å±‚çš„éªŒè¯é€»è¾‘å·²ç»æ¯”è¾ƒåˆç†ï¼Œé—®é¢˜åœ¨C++çš„æ£€æµ‹é˜¶æ®µ

---

## ğŸ¯ æ¨èå®æ–½æ­¥éª¤

### ç¬¬1æ­¥: éªŒè¯æ–¹æ¡ˆAï¼ˆPythonï¼‰
1. ä¿®æ”¹ `cv_debug_visualizer.py` çš„ç›´çº¿åˆ†ç±»é€»è¾‘
2. é‡æ–°è¿è¡Œæ‰¹é‡è¯Šæ–­
3. å¯¹æ¯”æ”¹è¿›å‰åçš„æˆåŠŸç‡

### ç¬¬2æ­¥: å¦‚æœæ–¹æ¡ˆAæœ‰æ•ˆï¼Œéƒ¨ç½²åˆ°C++
1. ä¿®æ”¹ `opencv_scanner.cpp:556-563`
2. é‡æ–°ç¼–è¯‘ Native.OpenCV åº“
3. éƒ¨ç½²åˆ°Androidæµ‹è¯•

### ç¬¬3æ­¥: å¦‚æœä»ä¸ç†æƒ³ï¼Œå°è¯•æ–¹æ¡ˆB+C
1. é™ä½Houghé˜ˆå€¼
2. æ·»åŠ å®¹é”™é€»è¾‘
3. é‡æ–°æµ‹è¯•

---

## ğŸ“ˆ é¢„æœŸæ”¹è¿›

åŸºäºå½“å‰13å¼ å›¾ç‰‡çš„åˆ†æï¼š

**æ”¹è¿›å‰:**
- æˆåŠŸç‡: ~50%
- ä¸»è¦å¤±è´¥: Vçº¿æ£€æµ‹ä¸åˆ°

**æ”¹è¿›åï¼ˆæ–¹æ¡ˆAï¼‰:**
- é¢„æœŸæˆåŠŸç‡: ~80%
- ä¸»è¦æ”¹è¿›: æ­£ç¡®åˆ†ç±»å€¾æ–œçš„Vçº¿

**æ”¹è¿›åï¼ˆæ–¹æ¡ˆA+B+Cï¼‰:**
- é¢„æœŸæˆåŠŸç‡: ~90%
- è¦†ç›–æ›´å¤šè¾¹ç¼˜æƒ…å†µ

---

## ğŸ“ æµ‹è¯•æ•°æ®ä½ç½®

- **æµ‹è¯•å›¾ç‰‡**: `D:\test_images\`
- **å¯è§†åŒ–ç»“æœ**: `D:\Programing\C#\MauiScan\cv_debug_output\`
- **è¯Šæ–­è„šæœ¬**: `D:\Programing\C#\MauiScan\cv_debug_visualizer.py`

### å…³é”®æ–‡ä»¶
- `P20251207-080152\` - å…¨éƒ¨å¤±è´¥æ¡ˆä¾‹ï¼ˆVçº¿=0ï¼‰
- `P20251207-080138\` - BLæ‹Ÿåˆå¤±è´¥æ¡ˆä¾‹ï¼ˆVçº¿=1ï¼‰
- `TEST\` - å…¨éƒ¨æˆåŠŸæ¡ˆä¾‹ï¼ˆVçº¿â‰¥2ï¼‰

---

## ğŸ”§ ä»£ç ä¿®æ”¹ä½ç½®

### PythonéªŒè¯è„šæœ¬
- **æ–‡ä»¶**: `cv_debug_visualizer.py`
- **ä½ç½®**: Line 128-140 (ç›´çº¿åˆ†ç±»é€»è¾‘)

### C++ Nativeåº“
- **æ–‡ä»¶**: `Native.OpenCV/src/opencv_scanner.cpp`
- **ä½ç½®**: Line 556-563 (ç›´çº¿åˆ†ç±»é€»è¾‘)
- **ä½ç½®**: Line 544 (Houghå‚æ•°)

### C# éªŒè¯å±‚ï¼ˆå·²æµ‹è¯•ï¼Œä¸æ¨èä¿®æ”¹ï¼‰
- **æ–‡ä»¶**: `MauiScan.ML/Platforms/Android/OnnxInferenceService.Android.cs`
- **ä½ç½®**: Line 91-110 (ç¦»ç¾¤æ£€æµ‹ï¼Œå·²å›é€€åˆ°åŸå§‹ç‰ˆæœ¬)

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¿®æ”¹C++åéœ€è¦é‡æ–°ç¼–è¯‘åº“**
   ```cmd
   cd D:\Programing\C#\MauiScan\Native.OpenCV\android
   build-android.bat
   ```

2. **PythonéªŒè¯è„šæœ¬ç”¨æ³•**
   ```bash
   python cv_debug_visualizer.py \
     --images "D:\test_images" \
     --model "MauiScan\Resources\Raw\ppt_corner_detector.onnx" \
     --output "cv_debug_output"
   ```

3. **æµ‹è¯•æ—¶å¯¹æ¯”æŒ‡æ ‡**
   - æˆåŠŸç‡ï¼ˆ4ä¸ªè§’ç‚¹å…¨éƒ¨ç²¾ä¿®æˆåŠŸçš„å›¾ç‰‡å æ¯”ï¼‰
   - å¹³å‡åç§»è·ç¦»ï¼ˆç²¾ä¿®ç‚¹ç›¸å¯¹MLç‚¹çš„åç§»ï¼‰
   - H/Vçº¿æ£€æµ‹æ•°é‡

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Native.OpenCV README](Native.OpenCV/android/README.md)
- [é¡¹ç›®æ€»README](.claude/CLAUDE.md)
